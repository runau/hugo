---
title: "awsでメールサーバーを立てる"
date: 2020-02-17T07:27:22+09:00
meta_image: "posts/meta_image/20200217_night.png"
tags: ["python","aws"]
categories: ["メール"]
---

このブログもだけど、ロリポップみたいなレンタルサーバーを借りてないので、メールサーバーも使えないのです。

なので、メールもawsで受信してます。

で、htmlメールが綺麗に受信できないので、対策しようかなと思っているところです。

今日は、まずその前に、今の現状をまとめておこうと思います！

## 構成

こんな感じ？

システム構成図とか仕事で書いたことないから書き方分からんww

![SESシステム構成図](../img/mail-server.png)

route53で独自ドメインを設定して、SESで受信して、一応s3にバックアップ保存して、SNSのtopicに内容投げて、SQSがサブスクリプションして、lambdaに投げて、lambdaでメールの内容読み取って、SNSに送って、サブスクリプションで別のメールに転送してます。

長い…ww

### メール読み取りlambda

ソースはこんな感じ

で、これだとhtmlメールが綺麗に受信できないのと、タイトルと宛先と受信元と…とかの情報が取れないのが今の課題…。

明日からはこの辺をなんとかする！

```lambda.py
import json
import email
import boto3

def lambda_handler(event, context):
    # TODO implement
    print(json.dumps(event))
    print(event["Records"][0]["body"])
    message = json.loads(event["Records"][0]["body"])
    # print(message["content"])
    try:
        print(email.message_from_string(message["content"]))
        email_body = response['Body'].read().decode('utf-8')
    except:
        email_body = message["content"]
    email_object = email.message_from_string(email_body)
    # print(email_object)
         
    body = ""
    for part in email_object.walk():
        # ContentTypeがmultipartの場合は実際のコンテンツはさらに
        # 中のpartにあるので読み飛ばす
        if part.get_content_maintype() == 'multipart':
            continue
        # ファイル名の取得
        attach_fname = part.get_filename()
        # ファイル名がない場合は本文のはず
        if not attach_fname:
            charset = str(part.get_content_charset())
            if charset:
                body += part.get_payload(decode=True).decode(charset, errors="replace")
            else:
                body += part.get_payload(decode=True)
        else:
            # ファイル名があるならそれは添付ファイル
            pass
    print(body)
    
    TOPIC_ARN = os.environ['TOPIC_ARN']
 
    client = boto3.client('sns')
     
    response = client.publish(
        TopicArn = TOPIC_ARN,
        Message = body,
        Subject = "メール受信"
    )

    return {
        'statusCode': 200
    }

```